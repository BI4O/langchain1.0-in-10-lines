# LangChain Agent ä¸­é—´ä»¶ä¸¤æ¬¡æ¨¡å‹è°ƒç”¨é—®é¢˜åˆ†ææŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

ç”¨æˆ·æŠ¥å‘Šæ¯æ¬¡å·¥å…·è°ƒç”¨éƒ½ä¼šè§¦å‘ä¸¤æ¬¡æ¨¡å‹è°ƒç”¨ï¼Œç»æµ‹è¯•ç¡®è®¤è¿™æ˜¯ä¸€ä¸ªçœŸå®çš„æ€§èƒ½é—®é¢˜ã€‚

## é—®é¢˜å¤ç°

é€šè¿‡æµ‹è¯•è„šæœ¬éªŒè¯ï¼Œå½“ Agent éœ€è¦è°ƒç”¨å·¥å…·æ—¶ï¼Œ`wrap_model_call` ä¸­é—´ä»¶ç¡®å®ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼š

1. **ç¬¬ä¸€æ¬¡è°ƒç”¨**ï¼šå¤„ç†ç”¨æˆ·åŸå§‹æ¶ˆæ¯ï¼Œå†³å®šæ˜¯å¦è°ƒç”¨å·¥å…·
2. **ç¬¬äºŒæ¬¡è°ƒç”¨**ï¼šå¤„ç†å·¥å…·è¿”å›çš„ç»“æœï¼Œç”Ÿæˆæœ€ç»ˆå“åº”

## æ ¹æœ¬åŸå› åˆ†æ

### 1. Agent æ‰§è¡Œæµç¨‹åˆ†æ

ä»æºç åˆ†æå‘ç°ï¼ŒLangChain Agent çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

```
ç”¨æˆ·æ¶ˆæ¯ â†’ before_model â†’ model_node â†’ after_model â†’ [å¦‚æœ‰å·¥å…·è°ƒç”¨] â†’ tools â†’ before_model â†’ model_node â†’ after_model â†’ æœ€ç»ˆå“åº”
```

### 2. å…³é”®ä»£ç ä½ç½®

åœ¨ `/Users/bi4o/anaconda3/lib/python3.11/site-packages/langchain/agents/factory.py` ä¸­ï¼š

- **ç¬¬1080è¡Œ**ï¼š`model_node` å‡½æ•°è´Ÿè´£æ¨¡å‹è°ƒç”¨
- **ç¬¬1093-1098è¡Œ**ï¼šä¸­é—´ä»¶æ‰§è¡Œé€»è¾‘
- **ç¬¬1479-1532è¡Œ**ï¼š`_make_model_to_tools_edge` æ§åˆ¶æµç¨‹è·³è½¬

### 3. è®¾è®¡åŸå› 

è¿™ä¸æ˜¯ä¸€ä¸ª bugï¼Œè€Œæ˜¯ LangChain Agent çš„**è®¾è®¡å¦‚æ­¤**ï¼š

1. **ç¬¬ä¸€æ¬¡æ¨¡å‹è°ƒç”¨**ï¼šåˆ†æç”¨æˆ·è¾“å…¥ï¼Œå†³å®šè°ƒç”¨å“ªäº›å·¥å…·
2. **å·¥å…·æ‰§è¡Œ**ï¼šæ‰§è¡Œé€‰å®šçš„å·¥å…·å¹¶è·å–ç»“æœ
3. **ç¬¬äºŒæ¬¡æ¨¡å‹è°ƒç”¨**ï¼šåŸºäºå·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆçš„ç”¨æˆ·å“åº”

è¿™ç§è®¾è®¡å…è®¸æ¨¡å‹åœ¨å·¥å…·è°ƒç”¨åé‡æ–°è¯„ä¼°æƒ…å†µï¼Œæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚

## æ€§èƒ½å½±å“åˆ†æ

### ä¼˜ç‚¹
- âœ… å…è®¸æ¨¡å‹åŸºäºå·¥å…·ç»“æœé‡æ–°æ€è€ƒ
- âœ… æ”¯æŒå¤šè½®å·¥å…·è°ƒç”¨å’Œå¤æ‚æ¨ç†
- âœ… æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†èƒ½åŠ›

### ç¼ºç‚¹
- âŒ å¢åŠ äº†å»¶è¿Ÿå’Œæˆæœ¬
- âŒ å¯¹äºç®€å•å·¥å…·è°ƒç”¨æ¥è¯´æ˜¯è¿‡åº¦è®¾è®¡
- âŒ ä¸­é—´ä»¶è¢«é‡å¤æ‰§è¡Œï¼Œå¯èƒ½å½±å“æ€§èƒ½

## ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¸­é—´ä»¶å†…éƒ¨ä¼˜åŒ–ï¼ˆæ¨èï¼‰

```python
@wrap_model_call
def optimized_middleware(request: ModelRequest, handler):
    # æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·åçš„è°ƒç”¨
    messages = request.messages
    is_tool_result_call = (
        len(messages) >= 3 and
        hasattr(messages[-1], '__class__') and
        messages[-1].__class__.__name__ == "ToolMessage"
    )

    if is_tool_result_call:
        # å·¥å…·ç»“æœè°ƒç”¨ - è·³è¿‡å¤æ‚é€»è¾‘
        print("ğŸ”„ å·¥å…·ç»“æœå¤„ç†è°ƒç”¨ï¼ˆè·³è¿‡å¤æ‚é€»è¾‘ï¼‰")
        return handler(request)
    else:
        # é¦–æ¬¡è°ƒç”¨ - æ‰§è¡Œå®Œæ•´é€»è¾‘
        print("ğŸš€ é¦–æ¬¡æ¨¡å‹è°ƒç”¨ï¼ˆæ‰§è¡Œå®Œæ•´é€»è¾‘ï¼‰")
        return handler(request)
```

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ before_model æ›¿ä»£éƒ¨åˆ†é€»è¾‘

å¯¹äºä¸éœ€è¦åœ¨å·¥å…·è°ƒç”¨åæ‰§è¡Œçš„é€»è¾‘ï¼Œå¯ä»¥ç§»åˆ° `before_model`ï¼š

```python
@before_model
def setup_tools(request: ModelRequest, handler):
    # åªåœ¨é¦–æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œçš„å·¥å…·è®¾ç½®é€»è¾‘
    messages = request.messages
    if len(messages) <= 2:  # ç®€å•åˆ¤æ–­æ˜¯å¦ä¸ºé¦–æ¬¡è°ƒç”¨
        print("è®¾ç½®å·¥å…·é…ç½®")
        # å·¥å…·é€‰æ‹©é€»è¾‘
```

### æ–¹æ¡ˆ3ï¼šæ¡ä»¶æ€§ä¸­é—´ä»¶æ‰§è¡Œ

```python
class SmartMiddleware:
    def __init__(self):
        self.call_count = 0

    def __call__(self, request: ModelRequest, handler):
        self.call_count += 1

        # åªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œå¤æ‚é€»è¾‘
        if self.call_count == 1:
            print("ğŸ¯ æ‰§è¡Œå¤æ‚é€»è¾‘ï¼ˆä»…é¦–æ¬¡ï¼‰")
            # å¤æ‚çš„å·¥å…·é€‰æ‹©ã€éªŒè¯ç­‰é€»è¾‘
        else:
            print("âš¡ å¿«é€Ÿå¤„ç†ï¼ˆå·¥å…·ç»“æœï¼‰")

        return handler(request)
```

## æœ€ä½³å®è·µå»ºè®®

### 1. ä¸­é—´ä»¶è®¾è®¡åŸåˆ™

- **è½»é‡åŒ–**ï¼š`wrap_model_call` ä¸­é—´ä»¶åº”è¯¥å°½å¯èƒ½è½»é‡
- **æ¡ä»¶æ‰§è¡Œ**ï¼šæ ¹æ®è°ƒç”¨é˜¶æ®µé€‰æ‹©æ€§æ‰§è¡Œé€»è¾‘
- **é¿å…é‡å¤**ï¼šä½¿ç”¨çŠ¶æ€ç®¡ç†é¿å…é‡å¤è®¡ç®—

### 2. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

```python
@wrap_model_call
def performance_optimized_middleware(request: ModelRequest, handler):
    # å¿«é€Ÿåˆ¤æ–­è°ƒç”¨é˜¶æ®µ
    is_followup = (
        len(request.messages) > 2 and
        any(hasattr(msg, 'tool_calls') for msg in request.messages[-3:])
    )

    if is_followup:
        # å·¥å…·ç»“æœå¤„ç† - æœ€å°åŒ–é€»è¾‘
        return handler(request)
    else:
        # é¦–æ¬¡å¤„ç† - æ‰§è¡Œå®Œæ•´é€»è¾‘
        # å·¥å…·é€‰æ‹©ã€éªŒè¯ç­‰
        return handler(request)
```

### 3. ç›‘æ§å’Œè°ƒè¯•

```python
@wrap_model_call
def debugging_middleware(request: ModelRequest, handler):
    call_id = id(request)
    print(f"[{call_id}] æ¨¡å‹è°ƒç”¨å¼€å§‹")
    print(f"[{call_id}] æ¶ˆæ¯æ•°é‡: {len(request.messages)}")

    start_time = time.time()
    result = handler(request)
    end_time = time.time()

    print(f"[{call_id}] æ¨¡å‹è°ƒç”¨å®Œæˆï¼Œè€—æ—¶: {end_time - start_time:.2f}s")
    return result
```

## ç»“è®º

1. **è¿™ä¸æ˜¯ bug**ï¼Œè€Œæ˜¯ LangChain Agent çš„è®¾è®¡ç‰¹æ€§
2. **ç¡®å®å­˜åœ¨æ€§èƒ½å½±å“**ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤æ‚ä¸­é—´ä»¶åœºæ™¯ä¸‹
3. **å¯ä»¥é€šè¿‡ä¼˜åŒ–ä¸­é—´ä»¶é€»è¾‘æ¥ç¼“è§£**æ€§èƒ½é—®é¢˜
4. **å»ºè®®æ ¹æ®å…·ä½“ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–ç­–ç•¥**

å¯¹äºå¤§å¤šæ•°åº”ç”¨åœºæ™¯ï¼Œå»ºè®®é‡‡ç”¨**æ–¹æ¡ˆ1ï¼ˆä¸­é—´ä»¶å†…éƒ¨ä¼˜åŒ–ï¼‰**ï¼Œå®ƒæ—¢ä¿æŒäº†è®¾è®¡çš„çµæ´»æ€§ï¼Œåˆæ˜¾è‘—æå‡äº†æ€§èƒ½ã€‚

## é™„å½•ï¼šæµ‹è¯•ä»£ç 

å®Œæ•´çš„æµ‹è¯•å’Œåˆ†æä»£ç å·²ä¿å­˜åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­ï¼š
- `test_middleware_calls.py` - åŸºç¡€ä¸­é—´ä»¶è°ƒç”¨æµ‹è¯•
- `test_middleware_with_tools.py` - å·¥å…·è°ƒç”¨åœºæ™¯æµ‹è¯•
- `middleware_analysis_report.md` - æœ¬åˆ†ææŠ¥å‘Š